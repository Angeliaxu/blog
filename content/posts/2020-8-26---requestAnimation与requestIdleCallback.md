---
title: requestAnimationFrameä¸requestIdleCallback
date: "2020-8-26"
template: "post"
draft: false
slug: "/post/requestAnimationFrameAndRequestIdleCallback/"
category: "JavaScript"
tags:
  - "js"
description: "requestAnimationFrame ç”¨æ¥ä¼˜åŒ–åŠ¨ç”»çš„æ‰§è¡Œæœºåˆ¶ï¼Œè®©åŠ¨ç”»è¾¾åˆ° 16.66ï¼ˆ1/60ï¼‰æ¯«ç§’çš„ä¸æ»‘ã€‚åœ¨ç”µè„‘æ˜¾å¡ä¸­æœ‰ä¸€å—å«åšå‰ç¼“å†²åŒºåŸŸçš„åœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹ç”¨æ¥å­˜æ”¾æ˜¾ç¤ºå™¨éœ€è¦æ˜¾ç¤ºå›¾åƒçš„åœ°æ–¹ã€‚æ˜¾ç¤ºå™¨ä¸€èˆ¬æ˜¯æ¯é—´éš” 1/60 ç§’å»å‰ç¼“å†²åŒºåŸŸè¯»å–æ–°çš„å›¾åƒã€‚"
socialImage: "/media/42-line-bible.jpg"
---

requestAnimationFrame ç”¨æ¥ä¼˜åŒ–åŠ¨ç”»çš„æ‰§è¡Œæœºåˆ¶ï¼Œè®©åŠ¨ç”»è¾¾åˆ° 16.66ï¼ˆ1/60ï¼‰æ¯«ç§’çš„ä¸æ»‘ã€‚åœ¨ç”µè„‘æ˜¾å¡ä¸­æœ‰ä¸€å—å«åšå‰ç¼“å†²åŒºåŸŸçš„åœ°æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹ç”¨æ¥å­˜æ”¾æ˜¾ç¤ºå™¨éœ€è¦æ˜¾ç¤ºå›¾åƒçš„åœ°æ–¹ã€‚æ˜¾ç¤ºå™¨ä¸€èˆ¬æ˜¯æ¯é—´éš” 1/60 ç§’å»å‰ç¼“å†²åŒºåŸŸè¯»å–æ–°çš„å›¾åƒã€‚å¦‚æœæµè§ˆå™¨è¦æ›´æ–°æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œä¼šç”Ÿæˆæ–°çš„å›¾ç‰‡æäº¤åˆ°æ˜¾å¡çš„åç¼“å†²åŒºåŸŸä¸­ã€‚æäº¤å®Œæˆä¹‹åï¼ŒGPU ä¼šç½®æ¢å‰ç¼“å†²å’Œåç¼“å†²ï¼Œåç¼“å†²å˜æˆå‰ç¼“å†²ï¼Œå‰ç¼“å†²å˜æˆåç¼“å†²ï¼Œä¿è¯æ˜¾ç¤ºå™¨æ¯æ¬¡éƒ½èƒ½è¯»å–åˆ°æœ€æ–°çš„å›¾ç‰‡ï¼Œå±•ç¤ºåœ¨äººçœ¼è·Ÿå‰ã€‚

ä½†æ˜¯æ€ä¹ˆä¿è¯æ˜¾ç¤ºå™¨ä¸æµè§ˆå™¨ä¹‹é—´çš„å·¥ä½œå…³ç³»å‘¢ï¼Œå…·ä½“æ¥è¯´å½“æ˜¾ç¤ºå™¨éœ€è¦å›¾ç‰‡çš„æ—¶å€™ï¼Œä½ æµè§ˆå™¨éœ€è¦ç»™æˆ‘å‡†å¤‡å¥½ï¼Œè®©æˆ‘æœ‰å›¾ç‰‡å¯è¯»ã€‚å…¶ä¸­ç”¨åˆ°äº† VSyncï¼ˆvertical synchronizationï¼‰å‚ç›´åŒæ­¥ä¿¡å·ï¼Œå½“æ˜¾ç¤ºå™¨è¯»å–å½“å‰å¸§å›¾ç‰‡å®Œæˆä¹‹åï¼Œåœ¨å‡†å¤‡è¯»å–ä¸‹ä¸€å¸§å›¾ç‰‡ä¹‹å‰ï¼Œæ˜¾ç¤ºå™¨ä¼šåƒ GPU å‘é€ VSync ä¿¡å·ï¼ŒGPU æ”¶åˆ°ä¿¡å·ä¼ é€’ç»™æµè§ˆå™¨è¿›ç¨‹ï¼Œæµè§ˆå™¨è¿›ç¨‹å¼€å§‹è¿›è¡Œä¸‹ä¸€å¸§å›¾ç‰‡çš„è®¡ç®—ã€‚è¿™ä¸ªè®¡ç®—ä¸­å¦‚æœæˆ‘ä»¬å®šä¹‰äº† requestAnimationFrame çš„å›è°ƒï¼Œé‚£ä¹ˆè¿™ä¸ªå›è°ƒä¼šæ­¤æ—¶ä¼šæ‰§è¡Œã€‚å¤§è‡´çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

![vsync](/media/vsync.png)

è¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ requestAnimationFrame èƒ½è¾¾åˆ°è®©åŠ¨ç”»ä¸æ»‘çš„æ•ˆæœã€‚åœ¨æ˜¾ç¤ºå™¨å‘é€ Vsync ä¿¡å·åˆ°æµè§ˆå™¨è¿›ç¨‹ï¼Œå¦‚æœæµè§ˆå™¨å™¨è¿›ç¨‹åœ¨è®¡ç®—å®Œå›¾åƒæœ‰å‰©ä½™çš„æ—¶é—´ï¼Œä¸Šé¢è¯´è¿‡ Vsyn å‘é€å‘¨æœŸæ˜¯ 16.66 æ¯«ç§’ï¼Œæ­¤æ—¶è®¡ç®—å›¾åƒåªèŠ±äº† 8 ç§’æˆ–è€…æ›´å°‘çš„æ—¶é—´ï¼Œé‚£ä¹ˆè¿˜æœ‰å‰©ä½™çš„ 8 ç§’æˆ–è€…æ›´å¤šçš„æ—¶é—´ï¼Œè¿™æ—¶æ¸²æŸ“ä¸»çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œå¯èƒ½ä¼šè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ requestIdleCallback åœ¨è¿™æ®µç©ºé—²æ—¶é—´æ‰§è¡ŒæŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚åŸæ¥ requestIdleCallback æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹æ‰§è¡Œï¼Œä¸‹é¢ä¸€å¼ å›¾äº†è§£ä¸‹ï¼š

![frame](/media/frame.jpg)

ç»“åˆä¸Šé¢çš„å¤§è‡´æè¿°ï¼Œå¯ä»¥æŠŠ requestAnimationFrame å’Œ requestIdleCallback çš„æ‰§è¡Œæ—¶æœºå¤§è‡´çš„äº†è§£äº†ä¸€ç•ªã€‚
æ¥ä¸‹æ¥çœ‹çœ‹ requestIdleCallbackã€‚
ä¸¾ä¸ªæ —å­ ğŸŒ°ï¼šå½“ä½ åœ¨æ»šåŠ¨é¡µé¢çš„æ—¶å€™ï¼Œä½ éœ€è¦ä¸Šä¼ ä¸€äº›ä¾›åˆ†æçš„æ•°æ®ï¼Œæˆ–è€…å½“ä½ ç‚¹å‡» buttonï¼Œéœ€è¦å¾€é¡µé¢æ’å…¥å…ƒç´ ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½ è‚¯å®šä¸æƒ³åœ¨æ»šåŠ¨æˆ–è€…ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œjs ä»£ç çš„æ‰§è¡Œé˜»ç¢äº†é¡µé¢ä½¿ç”¨æ•ˆæœã€‚æ‰€ä»¥ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ requestIdleCallback æ¥è§£å†³ä¸Šé¢æè¿°çš„é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ èƒ½åœ¨ä¸é˜»ç¢ç”¨æˆ·ä¸é¡µé¢äº¤äº’çš„æƒ…å†µä¸‹ï¼Œå»æ‰§è¡Œ js ä»£ç ï¼Œè¿™ä¸ªåŠŸèƒ½ä» chrome47 ç‰ˆæœ¬ä¹‹åå°±å¯ä»¥ä½¿ç”¨ã€‚åœ¨å®Œæˆ requestAnimationFrame å›è°ƒä¹‹åï¼Œæµè§ˆå™¨è¿›ç¨‹è¿˜ä¼šè¿›è¡Œæ ·å¼è®¡ç®—ï¼Œå¸ƒå±€ï¼Œé‡ç»˜ï¼Œæˆ–è€…å…¶ä»–æ¶ˆæ¯ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ requestAnimationFrame çš„æ—¶å€™ï¼Œå¯ä»¥ç²¾ç¡®çš„çŸ¥é“ï¼Œå½“å‰å¸§æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè¿˜å‰©ä½™å¤šå°‘æ—¶é—´æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚

Best Practice
requestIdleCallback((param)=>{})ï¼Œå½“å›è°ƒæ‰§è¡Œçš„æ—¶å€™ï¼Œå›è°ƒå‚æ•°æ˜¯ä¸€ä¸ª deadline objectï¼Œå¯ä»¥é€šè¿‡ deadline.timeRemaining()æ¥è·å–å½“å‰å­˜åœ¨çš„å¯ç”¨æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ä»æ­£æ•°ä¸€ç›´å‡å°‘åˆ° 0ã€‚deadline.didTimeout è¡¨ç¤ºå‰©ä½™æ—¶é—´æ˜¯å¦ç”¨å°½

```
function myNonEssentialWork (deadline) {
  while (deadline.timeRemaining() > 0) {
    console.log(deadline.timeRemaining());
    console.log(deadline.didTimeout,'didTimeout')
  }

}
requestIdleCallback(myNonEssentialWork);
```

ä¸‹å›¾æˆªå–çš„æ˜¯éƒ¨åˆ†ä¸Šé¢ä»£ç æ‰§è¡Œçš„ç»“æœ

![remainTime](/media/remainTime.jpg)

åŠ å…¥æµè§ˆå™¨ä¸­ä¸€ç›´æœ‰ä¸€é¡¹ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹ï¼Œæ€ä¹ˆæ‰èƒ½ä¿è¯ requestIdleCallback å¿…é¡»èƒ½æ‰§è¡Œå‘¢ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ¥å—ä¸€ä¸ªæ¯«ç§’çº§çš„æ•°æ®ï¼Œ
ä¿è¯å›è°ƒä¼šåœ¨æŒ‡å®šçš„æ¯«ç§’ä¹‹åè§¦å‘ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæä¾›ç¬¬äºŒä¸ªå‚æ•°ä¹‹åï¼Œdeadline.timeRemaining()ä¸€ç›´éƒ½ä¼šæ˜¯ 0ï¼Œdeadline.didTimeout ä¸€ç›´éƒ½ä¼šè¿”å› trueã€‚åœ¨éœ€è¦ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°çš„æƒ…å†µä¸‹è¿™ç§æ“ä½œå¯èƒ½ä¼šå¼•èµ·é¡µé¢é˜»å¡ã€‚

ä»¥ä¸Šå°±æ˜¯å¯¹ requestAnimationFrame ä¸ requestIdleCallback çš„ä»‹ç»ï¼ŒåŸºäº requestIdleCallbackï¼Œè¿˜å¯ä»¥å»¶ä¼¸å‡ºåœ¨ react Fiber ä¸­çš„ä½¿ç”¨ï¼Œä»¥åŠä¸ºä»€ä¹ˆ React éœ€è¦å¯¹å…¶ reconciliation è¿›è¡Œä¼˜åŒ–ã€‚
